# Updated for proper 64-bit builds
name: Build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2025
            build_script: createtfgrubprojects-nopause.bat
            build_cmd: msbuild grub_fortress.sln /p:Configuration=Release /p:Platform=win64 /m
            artifact_name: tfgrub-windows
          - os: ubuntu-latest
            build_script: ./buildtfgrubprojects
            build_cmd: ""
            artifact_name: tfgrub-linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Python (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get install -y python3

      #-- caching
      - name: Setup ccache (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache
          # ensure ccache wrapper is in PATH
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV
          # set CCACHE_DIR to runner home so logs and stats live in a writable place
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

      - name: ~/.ccache stuff (Linux)
        if: runner.os == 'Linux'
        run: |
          mkdir -p "$HOME/.ccache"
          # Create ccache.conf with a log_file inside the runner's ccache dir (expand $HOME)
          cat > "$HOME/.ccache/ccache.conf" <<EOF
          max_size = 2G
          compression = true
          hash_dir = false
          base_dir = /my_mod/src
          sloppiness = include_file_mtime,include_file_ctime,time_macros,pch_defines,file_stat_matches,locale,system_headers,clang_index_store
          # Use the runner home ccache dir
          log_file = $HOME/.ccache/ccache.log
          direct_mode = false
          debug = true
          EOF
          # Remove leading whitespace from heredoc lines
          sed -i 's/^[[:space:]]*//' "$HOME/.ccache/ccache.conf"
          # Ensure log and stats files exist and are writable
          touch "$HOME/.ccache/ccache.log" "$HOME/.ccache/stats"
          chmod 600 "$HOME/.ccache/ccache.conf" "$HOME/.ccache/ccache.log" "$HOME/.ccache/stats"
          echo "Created ccache.conf and log files at $HOME/.ccache"
          cat "$HOME/.ccache/ccache.conf"

      - name: Restore ccache cache (Linux)
        if: runner.os == 'Linux'
        uses: actions/cache/restore@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Restore VPC/Ninja cache (Linux)
        if: runner.os == 'Linux'
        uses: actions/cache/restore@v4
        with:
          path: src/_vpc_
          key: ${{ runner.os }}-vpc-v4-${{ hashFiles('src/**/*.vpc', 'src/**/vpc_scripts/**') }}
          restore-keys: |
            ${{ runner.os }}-vpc-v4-

      - name: Restore Windows build cache
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\AppData\Local\Microsoft\MSBuild
            C:\Users\runneradmin\AppData\Local\Temp
          key: ${{ runner.os }}-msvc-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-msvc-
      #-- end caching

      - name: Install Linux build dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install -y g++-multilib ninja-build lib32z1-dev podman file

      - name: Setup MSBuild (Windows only)
        if: runner.os == 'Windows'
        uses: microsoft/setup-msbuild@v2

      - name: Generate project files (Windows)
        run: ${{ matrix.build_script }}
        shell: cmd
        working-directory: src
        if: runner.os == 'Windows'

      # Set 64-bit compilation environment
      - name: Set 64-bit build environment (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "CFLAGS=-m64" >> $GITHUB_ENV
          echo "CXXFLAGS=-m64" >> $GITHUB_ENV
          echo "LDFLAGS=-m64" >> $GITHUB_ENV
          # reaffirm CCACHE_DIR in case it's not already set
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
        shell: bash

      - name: Show ccache stats before build (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "=== ccache statistics before build ==="
          ccache -s || true
          echo ""
          echo "=== Zero ccache stats for clean measurement ==="
          ccache -z || true
          echo ""
          echo "=== ccache config ==="
          cat ~/.ccache/ccache.conf || true
          echo ""
          echo "=== Verify ccache is accessible ==="
          which ccache || echo "ccache not found in PATH"
          ccache --version || echo "ccache version check failed"
          echo ""
          echo "=== Check if ninja uses ccache ==="
          if [ -f src/_vpc_/ninja/sdk_everything_release.ninja ]; then
            grep -E \"^rule (cc|cxx)\" src/_vpc_/ninja/sdk_everything_release.ninja -A2 | head -20 || echo "No compiler rules found"
          fi
        shell: bash

      - name: Build (Linux)
        run: |
          chmod +x ${{ matrix.build_script }}
          ${{ matrix.build_script }}
        working-directory: src
        shell: bash
        if: runner.os == 'Linux'

      # Verify all libraries are 64-bit
      - name: Verify library architecture (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Verifying all .so files are 64-bit..."
          
          # Check libraries in src/lib/public/linux64/
          if [ -d "src/lib/public/linux64" ]; then
            for lib in src/lib/public/linux64/*.so; do
              if [ -f "$lib" ]; then
                echo "Checking $lib:"
                file "$lib" | grep -q "ELF 64-bit" || {
                  echo "ERROR: $lib is not 64-bit!"
                  file "$lib"
                  exit 1
                }
                echo "✓ $lib is 64-bit"
              fi
            done
          fi
          
          # Check game binaries
          if [ -d "game/grub_fortress/bin/linux64" ]; then
            for lib in game/grub_fortress/bin/linux64/*.so; do
              if [ -f "$lib" ]; then
                echo "Checking $lib:"
                file "$lib" | grep -q "ELF 64-bit" || {
                  echo "ERROR: $lib is not 64-bit!"
                  file "$lib"
                  exit 1
                }
                echo "✓ $lib is 64-bit"
              fi
            done
          fi
          
          # Check main executable
          if [ -f "game/grub_fortress_linux64" ]; then
            echo "Checking game/grub_fortress_linux64:"
            file "game/grub_fortress_linux64" | grep -q "ELF 64-bit" || {
              echo "ERROR: grub_fortress_linux64 is not 64-bit!"
              file "game/grub_fortress_linux64"
              exit 1
            }
            echo "✓ grub_fortress_linux64 is 64-bit"
          fi
          
          echo "All binaries verified as 64-bit ✓"
        shell: bash

      - name: Clean and strip (Linux)
        if: runner.os == 'Linux'
        run: |
          find game/grub_fortress/bin/linux64 -type f -executable -exec strip --strip-all {} +
          if [ -f game/grub_fortress_linux64 ]; then
            strip --strip-all game/grub_fortress_linux64
          fi
        shell: bash

      - name: Build (Windows only)
        if: runner.os == 'Windows'
        working-directory: src
        run: ${{ matrix.build_cmd }}

      - name: Show ccache stats (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "=== ccache directory contents ==="
          ls -la ~/.ccache/ || echo "~/.ccache not found"
          echo ""
          echo "=== ccache statistics (from host) ==="
          CCACHE_DIR=~/.ccache ccache -s || echo "ccache -s failed"
          echo ""
          echo "=== ccache configuration ==="
          cat ~/.ccache/ccache.conf || echo "No config file"
          echo ""
          echo "=== ccache stats file ==="
          cat ~/.ccache/stats 2>/dev/null || echo "No stats file found"
          echo ""
          echo "=== ccache log (last 200 lines) ==="
          tail -200 ~/.ccache/ccache.log 2>/dev/null || echo "No log file found"
          echo ""
          echo "=== Uncacheable reasons (from log) ==="
          grep -oE "Result: [a-z_]+" ~/.ccache/ccache.log 2>/dev/null | sort | uniq -c | sort -rn | head -20 || echo "No results found in log"
        shell: bash

      - name: Save ccache (Linux)
        if: runner.os == 'Linux'
        uses: actions/cache/save@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.run_id }}

      - name: Save VPC/Ninja cache (Linux)
        if: runner.os == 'Linux'
        uses: actions/cache/save@v4
        with:
          path: src/_vpc_
          key: ${{ runner.os }}-vpc-v4-${{ hashFiles('src/**/*.vpc', 'src/**/vpc_scripts/**') }}

      - name: Save Windows build cache
        if: runner.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            C:\Users\runneradmin\AppData\Local\Microsoft\MSBuild
            C:\Users\runneradmin\AppData\Local\Temp
          key: ${{ runner.os }}-msvc-${{ github.sha }}

      - name: Clean up Windows build
        if: runner.os == 'Windows'
        run: |
            for /r "game" %%f in (*.pdb) do del /q "%%f"
        shell: cmd

      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-binaries
          path: game/grub_fortress/bin

      - name: Upload Game Folder
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: game/